#!/bin/bash
set -e

echo "=========================================="
echo "üì¶ [BUILD] –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
echo "=========================================="

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ [BUILD] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
python3.12 -m venv /app/.venv || python -m venv /app/.venv
. /app/.venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
echo "=========================================="
echo "üì¶ [BUILD] –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
echo "=========================================="
echo "üì¶ [BUILD] –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ frontend..."
ls -la /app/frontend || echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è frontend –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

if [ -d "/app/frontend" ]; then
    cd /app/frontend
    echo "üì¶ [BUILD] –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
    echo "üì¶ [BUILD] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    npm install
    echo "üì¶ [BUILD] –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ (npm run build)..."
    npm run build
    echo "üì¶ [BUILD] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–±–æ—Ä–∫–∏..."
    ls -la /app/public/js/ || echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è public/js –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    ls -la /app/public/css/ || echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è public/css –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    test -f /app/public/hash-map.json && echo "‚úÖ hash-map.json —Å–æ–∑–¥–∞–Ω" || echo "‚ö†Ô∏è hash-map.json –ù–ï —Å–æ–∑–¥–∞–Ω"
else
    echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è frontend –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞"
fi

echo "=========================================="
echo "üì¶ [BUILD] –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo "=========================================="

