[phases.setup]
nixPkgs = [
  "nodejs_22",
  "npm-9_x",
  "python3",
  "python3Packages.pip",
  "pkg-config",
  "opencv4",
  "gcc",
  "cmake"
]

[variables]
PYTHON = "python3"
npm_config_python = "python3"

[phases.install]
cmds = [
  "export PYTHON=$(which python3) && export npm_config_python=$(which python3) && echo 'üîç Python path: $PYTHON' && npm i"
]

[phases.build]
cmds = [
  "echo 'üîç === OpenCV Build Debug Info ==='",
  "echo 'üîç Python: $(which python3)'",
  "echo 'üîç Python version: $(python3 --version)'",
  "echo 'üîç GCC: $(which gcc)'",
  "echo 'üîç GCC version: $(gcc --version | head -1)'",
  "echo 'üîç CMake: $(which cmake)'",
  "echo 'üîç CMake version: $(cmake --version | head -1)'",
  "echo 'üîç pkg-config: $(which pkg-config)'",
  "echo 'üîç Checking OpenCV installation...'",
  "pkg-config --modversion opencv4 2>&1 || echo '‚ö†Ô∏è pkg-config opencv4 not found'",
  "pkg-config --cflags opencv4 2>&1 || echo '‚ö†Ô∏è pkg-config opencv4 cflags not found'",
  "pkg-config --libs opencv4 2>&1 || echo '‚ö†Ô∏è pkg-config opencv4 libs not found'",
  "find /nix/store -name 'opencv*' -type d 2>/dev/null | head -5 || echo '‚ö†Ô∏è OpenCV not found in /nix/store'",
  "find /nix/store -name 'opencv*.pc' 2>/dev/null | head -5 || echo '‚ö†Ô∏è OpenCV .pc files not found'",
  "echo 'üîç Attempting OpenCV rebuild with verbose output...'",
  "npm rebuild @u4/opencv4nodejs --verbose 2>&1 | tail -100 || echo '‚ö†Ô∏è OpenCV rebuild failed - face detection will be disabled'"
]

[start]
cmd = "node start-all.js"
