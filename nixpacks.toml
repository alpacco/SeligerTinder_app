[phases.setup]
nixPkgs = [
  "nodejs_22",
  "npm-9_x",
  "python3",
  "python3Packages.pip",
  "pkg-config",
  "opencv4",
  "gcc",
  "cmake"
]

[variables]
PYTHON = "python3"
npm_config_python = "python3"

[phases.install]
cmds = [
  "export PATH=/nix/store/*/bin:$PATH",
  "export PYTHON=$(which python3) && export npm_config_python=$(which python3)",
  "export NODE_PATH=$(which node | xargs dirname)",
  "export PKG_CONFIG_PATH=$(find /nix/store -name 'opencv4.pc' -o -name 'opencv.pc' 2>/dev/null | head -1 | xargs dirname 2>/dev/null || echo ''):$PKG_CONFIG_PATH",
  "echo 'üîç Node.js version:' && node --version",
  "echo 'üîç npm version:' && npm --version",
  "echo 'üîç Python path: $PYTHON'",
  "echo 'üîç PKG_CONFIG_PATH: $PKG_CONFIG_PATH'",
  "echo 'üîç Searching for OpenCV...'",
  "find /nix/store -name 'opencv*.pc' 2>/dev/null | head -3 || echo '‚ö†Ô∏è No OpenCV .pc files found'",
  "npm i",
  "echo 'üîç === OpenCV Diagnostics After npm install ==='",
  "echo 'üîç Node.js:' && node --version",
  "echo 'üîç npm:' && npm --version",
  "echo 'üîç Python:' && which python3 && python3 --version",
  "echo 'üîç GCC:' && which gcc && gcc --version | head -1",
  "echo 'üîç CMake:' && which cmake && cmake --version | head -1",
  "echo 'üîç pkg-config:' && which pkg-config",
  "echo 'üîç PKG_CONFIG_PATH: $PKG_CONFIG_PATH'",
  "echo 'üîç Checking OpenCV...'",
  "(pkg-config --modversion opencv4 2>&1 || pkg-config --modversion opencv 2>&1 || echo '‚ö†Ô∏è pkg-config opencv4/opencv not found')",
  "(pkg-config --cflags opencv4 2>&1 || pkg-config --cflags opencv 2>&1 || echo '‚ö†Ô∏è pkg-config opencv4/opencv cflags not found')",
  "(pkg-config --libs opencv4 2>&1 || pkg-config --libs opencv 2>&1 || echo '‚ö†Ô∏è pkg-config opencv4/opencv libs not found')",
  "echo 'üîç === Attempting OpenCV Rebuild ==='",
  "npm rebuild @u4/opencv4nodejs --verbose 2>&1 || echo '‚ö†Ô∏è OpenCV rebuild failed - face detection will be disabled'"
]

[phases.build]
cmds = ["echo 'Build phase completed'"]

[start]
cmd = "node start-all.js"
