[phases.setup]
nixPkgs = [
  "nodejs_22",
  "npm-9_x",
  "python3",
  "python3Packages.pip",
  "pkg-config",
  "opencv",
  "gcc",
  "cmake"
]

[variables]
PYTHON = "python3"
npm_config_python = "python3"

[phases.install]
cmds = [
  "echo 'üîß Preparing build environment...'",
  "echo 'üîç Node.js version:' && node --version",
  "echo 'üîç npm version:' && npm --version",
  "echo 'üîç Python path:' && which python3 && python3 --version",
  "echo 'üîç PKG_CONFIG_PATH:' && echo $PKG_CONFIG_PATH",
  "echo 'üîç Searching for OpenCV .pc files...' && find /nix/store -name 'opencv*.pc' 2>/dev/null | head -3 || echo '‚ö†Ô∏è No OpenCV .pc files found'",
  "export PATH=/nix/store/*/bin:$PATH; PY_BIN=$(which python3); export PYTHON=$PY_BIN; export npm_config_python=$PY_BIN; OPENCV_PC=$(find /nix/store -name 'opencv*.pc' -print -quit 2>/dev/null || true); if [ -n \"$OPENCV_PC\" ]; then OPENCV_PKGCONFIG_DIR=$(dirname \"$OPENCV_PC\"); OPENCV_LIB_DIR=$(dirname \"$OPENCV_PKGCONFIG_DIR\"); export PKG_CONFIG_PATH=\"$OPENCV_PKGCONFIG_DIR:${PKG_CONFIG_PATH:-}\"; export LD_LIBRARY_PATH=\"$OPENCV_LIB_DIR:${LD_LIBRARY_PATH:-}\"; echo \"üîç Found OpenCV .pc at: $OPENCV_PC\"; else echo '‚ö†Ô∏è OpenCV .pc files not found (continuing without native support)'; fi; npm i",
  "echo 'üîç === OpenCV Diagnostics After npm install ==='",
  "OPENCV_PC=$(find /nix/store -name 'opencv*.pc' -print -quit 2>/dev/null || true); if [ -n \"$OPENCV_PC\" ]; then OPENCV_PKGCONFIG_DIR=$(dirname \"$OPENCV_PC\"); OPENCV_LIB_DIR=$(dirname \"$OPENCV_PKGCONFIG_DIR\"); export PKG_CONFIG_PATH=\"$OPENCV_PKGCONFIG_DIR:${PKG_CONFIG_PATH:-}\"; export LD_LIBRARY_PATH=\"$OPENCV_LIB_DIR:${LD_LIBRARY_PATH:-}\"; echo \"üîç OpenCV .pc detected at: $OPENCV_PC\"; else echo '‚ö†Ô∏è OpenCV .pc files not found'; fi",
  "echo 'üîç Node.js:' && node --version",
  "echo 'üîç npm:' && npm --version",
  "echo 'üîç Python:' && which python3 && python3 --version",
  "echo 'üîç GCC:' && which gcc && gcc --version | head -1",
  "echo 'üîç CMake:' && which cmake && cmake --version | head -1",
  "echo 'üîç pkg-config:' && which pkg-config",
  "echo 'üîç PKG_CONFIG_PATH:' && echo $PKG_CONFIG_PATH",
  "echo 'üîç Checking OpenCV with pkg-config...'",
  "(pkg-config --modversion opencv4 2>&1 || pkg-config --modversion opencv 2>&1 || echo '‚ö†Ô∏è pkg-config opencv4/opencv not found')",
  "(pkg-config --cflags opencv4 2>&1 || pkg-config --cflags opencv 2>&1 || echo '‚ö†Ô∏è pkg-config opencv4/opencv cflags not found')",
  "(pkg-config --libs opencv4 2>&1 || pkg-config --libs opencv 2>&1 || echo '‚ö†Ô∏è pkg-config opencv4/opencv libs not found')",
  "echo 'üîç === Attempting OpenCV Rebuild ==='",
  "OPENCV_PC=$(find /nix/store -name 'opencv*.pc' -print -quit 2>/dev/null || true); if [ -n \"$OPENCV_PC\" ]; then OPENCV_PKGCONFIG_DIR=$(dirname \"$OPENCV_PC\"); OPENCV_LIB_DIR=$(dirname \"$OPENCV_PKGCONFIG_DIR\"); export PKG_CONFIG_PATH=\"$OPENCV_PKGCONFIG_DIR:${PKG_CONFIG_PATH:-}\"; export LD_LIBRARY_PATH=\"$OPENCV_LIB_DIR:${LD_LIBRARY_PATH:-}\"; echo \"üîç Rebuild will use OpenCV .pc at: $OPENCV_PC\"; else echo '‚ö†Ô∏è OpenCV .pc files not found -- rebuild will likely fail'; fi; npm rebuild @u4/opencv4nodejs --verbose 2>&1 || echo '‚ö†Ô∏è OpenCV rebuild failed - face detection will be disabled'",
]

[phases.build]
cmds = ["echo 'Build phase completed'"]

[start]
cmd = "node start-all.js"
